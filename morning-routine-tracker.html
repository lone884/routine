<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* è¨­å®šç”»é¢ */
        .routine-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .routine-item:hover {
            background: #f0f0f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .routine-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .move-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .move-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .move-btn:hover {
            background: #5568d3;
        }

        .move-btn:active {
            transform: scale(0.95);
        }

        .move-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .drag-handle {
            font-size: 20px;
            color: #999;
            cursor: move;
            user-select: none;
            display: none; /* PCã§ã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ */
        }

        .routine-item input[type="text"] {
            flex: 3;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .routine-item input[type="number"] {
            width: 80px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }

        .time-unit {
            font-size: 16px;
            color: #666;
            white-space: nowrap;
        }

        .routine-item .delete-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .routine-item .delete-btn:hover {
            background: #ff3838;
        }

        .btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48dbfb;
        }

        .btn-secondary:hover {
            background: #2bcbf5;
        }

        /* å®Ÿè¡Œç”»é¢ */
        .timer-display {
            text-align: center;
            margin: 40px 0;
        }

        .current-task {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 72px;
            font-weight: 700;
            color: #667eea;
            font-family: 'Courier New', monospace;
            margin: 30px 0;
        }

        .timer.overtime {
            color: #ff4757;
        }

        .target-time {
            font-size: 20px;
            color: #666;
            margin-bottom: 10px;
        }

        .progress-info {
            font-size: 18px;
            color: #888;
            margin-top: 20px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-large {
            padding: 20px 40px;
            font-size: 20px;
        }

        .btn-success {
            background: #26de81;
        }

        .btn-success:hover {
            background: #20bf6b;
        }

        /* è¨˜éŒ²ç”»é¢ */
        .history-item {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .history-date {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
        }

        .history-tasks {
            display: grid;
            gap: 10px;
        }

        .history-task {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .task-name {
            font-weight: 600;
        }

        .task-time {
            color: #666;
        }

        .task-time.overtime {
            color: #ff4757;
            font-weight: 600;
        }

        /* çµ±è¨ˆç”»é¢ */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .stats-table th,
        .stats-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .stats-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .stats-table tr:hover {
            background: #f5f5f5;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
        }

        @media (max-width: 600px) {
            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 24px;
            }

            .timer {
                font-size: 56px;
            }

            .current-task {
                font-size: 24px;
            }

            .control-buttons {
                flex-direction: column;
            }

            .routine-item {
                flex-wrap: wrap;
                gap: 8px;
                padding: 12px;
            }

            .move-buttons {
                order: 1;
                flex-direction: row;
                gap: 4px;
            }

            .move-btn {
                width: 36px;
                height: 36px;
            }

            .routine-item input[type="text"] {
                flex: 1 1 100%;
                order: 2;
            }

            .routine-item input[type="number"] {
                order: 3;
                width: 70px;
            }

            .time-unit {
                order: 4;
            }

            .routine-item .delete-btn {
                order: 5;
                margin-left: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â˜€ï¸ æœã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
            <p>æ¯æ—¥ã®ç¿’æ…£ã‚’è¨˜éŒ²ã—ã¦ã€ç†æƒ³ã®æœã‚’æ‰‹ã«å…¥ã‚Œã‚ˆã†</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('setup')">è¨­å®š</button>
            <button class="tab" onclick="showTab('run')">å®Ÿè¡Œ</button>
            <button class="tab" onclick="showTab('history')">è¨˜éŒ²</button>
            <button class="tab" onclick="showTab('stats')">çµ±è¨ˆ</button>
        </div>

        <div class="content">
            <!-- è¨­å®šç”»é¢ -->
            <div id="setup" class="section active">
                <h2 style="margin-bottom: 20px;">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚’è¨­å®š</h2>
                <div id="routine-list"></div>
                <button class="btn btn-secondary" onclick="addRoutineItem()">+ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
                <button class="btn" onclick="saveRoutine()">ä¿å­˜</button>
            </div>

            <!-- å®Ÿè¡Œç”»é¢ -->
            <div id="run" class="section">
                <div id="run-content">
                    <div class="no-data">
                        <p>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>

            <!-- è¨˜éŒ²ç”»é¢ -->
            <div id="history" class="section">
                <h2 style="margin-bottom: 20px;">å®Ÿè¡Œå±¥æ­´ï¼ˆç›´è¿‘5å›ï¼‰</h2>
                <div id="history-list"></div>
            </div>

            <!-- çµ±è¨ˆç”»é¢ -->
            <div id="stats" class="section">
                <h2 style="margin-bottom: 20px;">ã‚¿ã‚¹ã‚¯åˆ¥çµ±è¨ˆ</h2>
                <div id="stats-content"></div>
            </div>
        </div>
    </div>

    <script>
        let routine = [];
        let currentTaskIndex = 0;
        let startTime = null;
        let timerInterval = null;
        let isRunning = false;
        let currentSessionData = [];
        let hasPlayedSound = false; // éŸ³ã‚’1å›ã ã‘å†ç”Ÿã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
        let alarmInterval = null; // ã‚¢ãƒ©ãƒ¼ãƒ ç”¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
        let isAlarmPlaying = false; // ã‚¢ãƒ©ãƒ¼ãƒ ãŒé³´ã£ã¦ã„ã‚‹ã‹ã®ãƒ•ãƒ©ã‚°

        // é€šçŸ¥éŸ³ã‚’ä½œæˆï¼ˆWeb Audio APIä½¿ç”¨ï¼‰
        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800; // å‘¨æ³¢æ•°
            oscillator.type = 'sine'; // æ³¢å½¢

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // ã‚¢ãƒ©ãƒ¼ãƒ ã‚’é–‹å§‹ï¼ˆç¹°ã‚Šè¿”ã—éŸ³ã‚’é³´ã‚‰ã™ï¼‰
        function startAlarm() {
            if (isAlarmPlaying) return;
            
            isAlarmPlaying = true;
            playNotificationSound();
            
            alarmInterval = setInterval(() => {
                playNotificationSound();
            }, 1000); // 1ç§’ã”ã¨ã«éŸ³ã‚’é³´ã‚‰ã™
        }

        // ã‚¢ãƒ©ãƒ¼ãƒ ã‚’åœæ­¢
        function stopAlarm() {
            if (alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
            isAlarmPlaying = false;
        }

        // åˆæœŸåŒ–
        function init() {
            loadRoutine();
            renderRoutineList();
            renderHistory();
            renderStats();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'history') {
                renderHistory();
            } else if (tabName === 'stats') {
                renderStats();
            }
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderRoutineList() {
            const list = document.getElementById('routine-list');
            list.innerHTML = '';

            routine.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'routine-item';
                div.dataset.index = index;
                
                const isFirst = index === 0;
                const isLast = index === routine.length - 1;
                
                div.innerHTML = `
                    <div class="move-buttons">
                        <button class="move-btn" onclick="moveItemUp(${index})" ${isFirst ? 'disabled' : ''}>â–²</button>
                        <button class="move-btn" onclick="moveItemDown(${index})" ${isLast ? 'disabled' : ''}>â–¼</button>
                    </div>
                    <input type="text" value="${item.name}" onchange="updateRoutineItem(${index}, 'name', this.value)" placeholder="ã‚¿ã‚¹ã‚¯åï¼ˆä¾‹ï¼šæ´—é¡”ï¼‰">
                    <input type="number" value="${item.targetMinutes}" onchange="updateRoutineItem(${index}, 'targetMinutes', this.value)" min="1" max="999">
                    <span class="time-unit">åˆ†</span>
                    <button class="delete-btn" onclick="removeRoutineItem(${index})">å‰Šé™¤</button>
                `;
                
                list.appendChild(div);
            });

            if (routine.length === 0) {
                addRoutineItem();
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸Šã«ç§»å‹•
        function moveItemUp(index) {
            if (index > 0) {
                const item = routine[index];
                routine[index] = routine[index - 1];
                routine[index - 1] = item;
                renderRoutineList();
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸‹ã«ç§»å‹•
        function moveItemDown(index) {
            if (index < routine.length - 1) {
                const item = routine[index];
                routine[index] = routine[index + 1];
                routine[index + 1] = item;
                renderRoutineList();
            }
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
        function addRoutineItem() {
            routine.push({ name: '', targetMinutes: 5 });
            renderRoutineList();
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
        function updateRoutineItem(index, field, value) {
            if (field === 'targetMinutes') {
                value = parseInt(value) || 5;
            }
            routine[index][field] = value;
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
        function removeRoutineItem(index) {
            routine.splice(index, 1);
            renderRoutineList();
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚’ä¿å­˜
        function saveRoutine() {
            const validRoutine = routine.filter(item => item.name.trim() !== '');
            if (validRoutine.length === 0) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            routine = validRoutine;
            localStorage.setItem('routine', JSON.stringify(routine));
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            updateRunSection();
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚’èª­ã¿è¾¼ã¿
        function loadRoutine() {
            const saved = localStorage.getItem('routine');
            if (saved) {
                routine = JSON.parse(saved);
            } else {
                routine = [
                    { name: 'ã†ãŒã„ã€æ´—é¡”', targetMinutes: 5 },
                    { name: 'ã‚µã‚¤ãƒªã‚¦ãƒ &ãƒãƒŠãƒŠ&æœé£Ÿæº–å‚™', targetMinutes: 10 },
                    { name: 'æœé£Ÿ', targetMinutes: 15 },
                    { name: 'æ­¯ç£¨ã', targetMinutes: 5 },
                    { name: 'ç­‹ãƒˆãƒ¬', targetMinutes: 5 },
                    { name: 'æ˜¼é£Ÿæº–å‚™&æ´—ã„ç‰©', targetMinutes: 10 },
                    { name: 'é«­å‰ƒã‚Š&ã‚³ãƒ¼ãƒ«ãƒ‰ã‚·ãƒ£ãƒ¯ãƒ¼', targetMinutes: 5 },
                    { name: 'ç€æ›¿ãˆ', targetMinutes: 15 }
                ];
            }
        }

        // å®Ÿè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateRunSection() {
            const runContent = document.getElementById('run-content');
            
            if (routine.length === 0) {
                runContent.innerHTML = '<div class="no-data"><p>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„</p></div>';
                return;
            }

            if (!isRunning) {
                runContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>æº–å‚™å®Œäº†ï¼</h2>
                        <p style="margin: 20px 0; font-size: 18px; color: #666;">
                            ${routine.length}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™
                        </p>
                        <button class="btn btn-large" onclick="startRoutine()">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³é–‹å§‹</button>
                    </div>
                `;
            }
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³é–‹å§‹
        function startRoutine() {
            currentTaskIndex = 0;
            currentSessionData = [];
            isRunning = true;
            startTask();
        }

        // ã‚¿ã‚¹ã‚¯é–‹å§‹
        function startTask() {
            if (currentTaskIndex >= routine.length) {
                finishRoutine();
                return;
            }

            const task = routine[currentTaskIndex];
            startTime = Date.now();
            hasPlayedSound = false; // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã§éŸ³å†ç”Ÿãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            
            const runContent = document.getElementById('run-content');
            runContent.innerHTML = `
                <div class="timer-display">
                    <div class="current-task">${task.name}</div>
                    <div class="target-time">ç›®æ¨™æ™‚é–“: ${task.targetMinutes}åˆ†</div>
                    <div class="timer" id="timer">00:00</div>
                    <div class="progress-info">${currentTaskIndex + 1} / ${routine.length}</div>
                    <div class="control-buttons">
                        <button class="btn btn-large btn-success" onclick="nextTask()">æ¬¡ã¸</button>
                        <button class="btn btn-large" style="background: #ff4757;" onclick="cancelRoutine()">ä¸­æ­¢</button>
                    </div>
                </div>
            `;

            startTimer();
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                    
                    const task = routine[currentTaskIndex];
                    const targetSeconds = task.targetMinutes * 60;
                    
                    // ç›®æ¨™æ™‚é–“ã«é”ã—ãŸã‚‰
                    if (seconds >= targetSeconds) {
                        timerElement.classList.add('overtime');
                        
                        // ç›®æ¨™æ™‚é–“ã¡ã‚‡ã†ã©ã«é”ã—ãŸæ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒ ã‚’é–‹å§‹ï¼ˆ1å›ã®ã¿ï¼‰
                        if (seconds === targetSeconds && !hasPlayedSound) {
                            startAlarm();
                            hasPlayedSound = true;
                            showStopAlarmButton();
                        }
                    }
                }
            }, 100);
        }

        // ã‚¢ãƒ©ãƒ¼ãƒ åœæ­¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        function showStopAlarmButton() {
            const controlButtons = document.querySelector('.control-buttons');
            if (controlButtons && !document.getElementById('stop-alarm-btn')) {
                const stopButton = document.createElement('button');
                stopButton.id = 'stop-alarm-btn';
                stopButton.className = 'btn btn-large';
                stopButton.style.background = '#ffa502';
                stopButton.textContent = 'ğŸ”” éŸ³ã‚’æ­¢ã‚ã‚‹';
                stopButton.onclick = function() {
                    stopAlarm();
                    this.remove();
                };
                controlButtons.insertBefore(stopButton, controlButtons.firstChild);
            }
        }

        // æ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸
        function nextTask() {
            stopAlarm(); // ã‚¢ãƒ©ãƒ¼ãƒ ã‚’åœæ­¢
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            const elapsed = Date.now() - startTime;
            const task = routine[currentTaskIndex];
            
            currentSessionData.push({
                name: task.name,
                targetMinutes: task.targetMinutes,
                actualSeconds: Math.floor(elapsed / 1000)
            });

            currentTaskIndex++;
            startTask();
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³å®Œäº†
        function finishRoutine() {
            stopAlarm(); // ã‚¢ãƒ©ãƒ¼ãƒ ã‚’åœæ­¢
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            isRunning = false;
            saveHistory(currentSessionData);

            const runContent = document.getElementById('run-content');
            const totalSeconds = currentSessionData.reduce((sum, task) => sum + task.actualSeconds, 0);
            const totalMinutes = Math.floor(totalSeconds / 60);
            const totalSecs = totalSeconds % 60;

            runContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 style="color: #26de81; font-size: 36px;">ğŸ‰ å®Œäº†ï¼</h2>
                    <p style="margin: 20px 0; font-size: 24px;">
                        åˆè¨ˆæ™‚é–“: ${totalMinutes}åˆ†${totalSecs}ç§’
                    </p>
                    <button class="btn btn-large" onclick="updateRunSection(); showTab('history')">è¨˜éŒ²ã‚’è¦‹ã‚‹</button>
                    <button class="btn btn-large btn-secondary" onclick="startRoutine()">ã‚‚ã†ä¸€åº¦å®Ÿè¡Œ</button>
                </div>
            `;
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³ä¸­æ­¢
        function cancelRoutine() {
            if (confirm('æœ¬å½“ã«ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                stopAlarm(); // ã‚¢ãƒ©ãƒ¼ãƒ ã‚’åœæ­¢
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                isRunning = false;
                currentSessionData = [];
                currentTaskIndex = 0;
                updateRunSection();
            }
        }

        // å±¥æ­´ã‚’ä¿å­˜
        function saveHistory(sessionData) {
            let history = JSON.parse(localStorage.getItem('history') || '[]');
            
            history.unshift({
                date: new Date().toISOString(),
                tasks: sessionData
            });

            // ç›´è¿‘5å›ã®ã¿ä¿å­˜
            history = history.slice(0, 5);
            localStorage.setItem('history', JSON.stringify(history));
        }

        // å±¥æ­´ã‚’è¡¨ç¤º
        function renderHistory() {
            const historyList = document.getElementById('history-list');
            const history = JSON.parse(localStorage.getItem('history') || '[]');

            if (history.length === 0) {
                historyList.innerHTML = '<div class="no-data">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            historyList.innerHTML = '';

            history.forEach(session => {
                const date = new Date(session.date);
                const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                const div = document.createElement('div');
                div.className = 'history-item';
                
                let tasksHtml = '';
                session.tasks.forEach(task => {
                    const minutes = Math.floor(task.actualSeconds / 60);
                    const seconds = task.actualSeconds % 60;
                    const isOvertime = task.actualSeconds > task.targetMinutes * 60;
                    
                    tasksHtml += `
                        <div class="history-task">
                            <span class="task-name">${task.name}</span>
                            <span class="task-time ${isOvertime ? 'overtime' : ''}">
                                ${minutes}:${String(seconds).padStart(2, '0')} 
                                (ç›®æ¨™: ${task.targetMinutes}åˆ†)
                            </span>
                        </div>
                    `;
                });

                div.innerHTML = `
                    <div class="history-date">${dateStr}</div>
                    <div class="history-tasks">${tasksHtml}</div>
                `;
                
                historyList.appendChild(div);
            });
        }

        // çµ±è¨ˆã‚’è¡¨ç¤º
        function renderStats() {
            const statsContent = document.getElementById('stats-content');
            const history = JSON.parse(localStorage.getItem('history') || '[]');

            if (history.length === 0) {
                statsContent.innerHTML = '<div class="no-data">ã¾ã çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ã‚¿ã‚¹ã‚¯åˆ¥ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            const taskStats = {};

            history.forEach(session => {
                session.tasks.forEach(task => {
                    if (!taskStats[task.name]) {
                        taskStats[task.name] = {
                            times: [],
                            targetMinutes: task.targetMinutes
                        };
                    }
                    taskStats[task.name].times.push(task.actualSeconds);
                });
            });

            // çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
            let tableHtml = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ã‚¿ã‚¹ã‚¯å</th>
                            <th>ç›®æ¨™</th>
                            <th>æœ€å°</th>
                            <th>æœ€å¤§</th>
                            <th>å¹³å‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(taskStats).forEach(taskName => {
                const data = taskStats[taskName];
                const times = data.times;
                
                const min = Math.min(...times);
                const max = Math.max(...times);
                const avg = times.reduce((a, b) => a + b, 0) / times.length;

                const formatTime = (seconds) => {
                    const m = Math.floor(seconds / 60);
                    const s = Math.floor(seconds % 60);
                    return `${m}:${String(s).padStart(2, '0')}`;
                };

                tableHtml += `
                    <tr>
                        <td><strong>${taskName}</strong></td>
                        <td>${data.targetMinutes}åˆ†</td>
                        <td>${formatTime(min)}</td>
                        <td>${formatTime(max)}</td>
                        <td>${formatTime(avg)}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            statsContent.innerHTML = tableHtml;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.onload = function() {
            init();
            updateRunSection();
        };
    </script>
</body>
</html>